name: PR Check

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - 'charts/**'

permissions:
  contents: read
  pull-requests: write

env:
  IMAGE_BASE: ${{ github.repository }}

jobs:
  test:
    name: Test Backend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: 'backend/go.mod'

      - name: Run Tests
        run: cd backend && go test -v ./...

  build-backend:
    name: Build Backend (Dry Run)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build
        uses: docker/build-push-action@v6
        with:
          context: backend
          load: true
          push: false
          tags: ${{ env.IMAGE_BASE }}-backend:pr-${{ github.event.number }}
          cache-from: type=gha,scope=backend

      - name: Run Trivy vulnerability scanner (FS)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: 'backend'
          scanners: 'vuln'
          hide-progress: true
          format: 'template'
          template: '@.github/trivy.tpl'
          output: 'trivy-backend-fs.md'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Upload Backend FS Trivy Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: trivy-backend-fs
          path: trivy-backend-fs.md

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ env.IMAGE_BASE }}-backend:pr-${{ github.event.number }}'
          format: 'template'
          template: '@.github/trivy.tpl'
          output: 'trivy-backend-image.md'
          scanners: 'vuln'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Upload Backend Image Trivy Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: trivy-backend-image
          path: trivy-backend-image.md

  build-frontend:
    name: Build Frontend (Dry Run)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build
        uses: docker/build-push-action@v6
        with:
          context: frontend
          load: true
          push: false
          tags: ${{ env.IMAGE_BASE }}-frontend:pr-${{ github.event.number }}
          cache-from: type=gha,scope=frontend

      - name: Run Trivy vulnerability scanner (FS)
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: 'fs'
          scan-ref: 'frontend'
          scanners: 'vuln'
          hide-progress: true
          format: 'template'
          template: '@.github/trivy.tpl'
          output: 'trivy-frontend-fs.md'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Upload Frontend FS Trivy Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: trivy-frontend-fs
          path: trivy-frontend-fs.md

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: '${{ env.IMAGE_BASE }}-frontend:pr-${{ github.event.number }}'
          format: 'template'
          template: '@.github/trivy.tpl'
          output: 'trivy-frontend-image.md'
          scanners: 'vuln'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Upload Frontend Image Trivy Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: trivy-frontend-image
          path: trivy-frontend-image.md

  report-security:
    name: Post Security Report
    needs: [build-backend, build-frontend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Download Trivy Reports
        uses: actions/download-artifact@v7
        with:
          pattern: trivy-*
          path: reports
          merge-multiple: true

      - name: Post Consolidated Security Report
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const reports = [
              { file: 'reports/trivy-backend-fs.md', title: 'Backend FS Vulnerability Scan' },
              { file: 'reports/trivy-backend-image.md', title: 'Backend Image Vulnerability Scan' },
              { file: 'reports/trivy-frontend-fs.md', title: 'Frontend FS Vulnerability Scan' },
              { file: 'reports/trivy-frontend-image.md', title: 'Frontend Image Vulnerability Scan' }
            ];

            let commentBody = '## üõ°Ô∏è Security Scan Results\n\n';
            let hasReports = false;

            for (const report of reports) {
              try {
                if (fs.existsSync(report.file)) {
                  const content = fs.readFileSync(report.file, 'utf8');
                  if (content.trim()) {
                    commentBody += `### ${report.title}\n\n${content}\n`;
                    hasReports = true;
                  }
                }
              } catch (error) {
                console.log(`Error reading ${report.file}: ${error.message}`);
              }
            }

            if (hasReports) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

